# TBOM UI 规范：EBOM 结构视图挂接入口与导航（v0.1）

> 日期：2025-10-15｜适用范围：前端原型｜关联：docs/prd.md（Story 1.2、1.5、1.9）、docs/tbom-contract.md

## 1. 背景与目标
- 在“产品结构（EBOM）”树节点上直观呈现与该节点挂接的试验（Test/TestRun），并提供一跳直达 TBOM 的入口。
- 统一导航与深链接参数，保证用户从结构视图⇄TBOM 的往返体验与上下文保持。

## 2. 用户与场景
- 结构工程师/评审人员：从某结构节点出发，快速查看其相关试验与结果。
- 试验工程师：对照结构节点核对试验覆盖范围、进度与结果。

## 3. 信息架构与导航
- 入口形态
  - 已有入口（过渡方案）：EBOM 节点详情区域的“跳转 试验BOM”按钮；
    - 行为：跳转到 `/tbom?from=ebom&node=<ebom_node_id>&path=<ebom_path>`，TBOM 侧按结构节点过滤。
  - 节点徽标（Badge）（计划新增）：在 EBOM 树每个可挂接节点右侧显示“试验”徽标与计数（合计 TestRun 数）。
  - 悬浮卡片（Popover）：悬停徽标显示试验类型分布（Top N）与最近一次运行时间。
  - 上下文菜单（Context Menu）：节点右键菜单新增“查看挂接试验”“在新标签中打开 TBOM”。
- 点击行为
  - 点击徽标：跳转到 `/tbom?node=<ebom_node_id>&path=<ebom_path>`，TBOM 侧激活“按结构节点过滤”并高亮该节点相关试验。
  - 右键菜单：“在新标签打开”以相同参数新开页；“查看挂接试验”在当前页打开。
- 反向导航
  - TBOM 页面顶部面包屑：`EBOM 节点路径（来自 ebom_path） → TBOM`，支持一键回到结构视图并定位节点。

## 4. 组件与状态
- 组件
  - `NodeTestBadge`：展示计数、颜色态、点击/键盘可达。
  - `NodeTestPopover`：显示类型分布与最近运行时间。
  - `NodeTestContextMenu`：右键菜单项。
- 状态
  - 空态：无试验时不显示徽标（或显示灰态 0，按产品决定，默认不显示）。
  - 加载：徽标显示骨架（闪烁条）或 `…`，Popover 显示 Loading。
  - 错误：徽标显示警示点，Popover 显示重试按钮。
- 辅助信息
  - Tooltip：`共有 X 次试验运行，Y 个试验`；
  - 颜色：蓝（可点击）、灰（无数据/禁用）、红（错误）。

## 5. 交互与可访问性
- 键盘：Tab 聚焦徽标，Enter 打开 TBOM，Shift+Enter 新标签打开。
- ARIA：徽标 `aria-label="查看挂接试验，计数 X"`；Popover 列表项可按方向键浏览。
- 焦点管理：从结构跳转到 TBOM 后，自动聚焦 TBOM 的过滤条并朗读筛选条件。

## 6. 响应式与性能
- 响应式：
  - `sm`：仅显示徽标点（不展示计数）；
  - `md/lg`：显示“试验 X”。
- 性能：
  - 树采用虚拟化；
  - 试验计数延迟加载（视口内节点批量请求/计算），避免首屏阻塞；
  - 缓存节点计数（LRU 100 条）。

## 7. 数据与参数
- 深链接参数
  - `node`：`ebom_node_id`（必填）
  - `path`：`ebom_path`（可选，UI 展示）
  - `from`：固定值 `ebom`
  - 可选：`type`（试验类型预过滤）
- 计数数据（原型阶段）
  - 从 Mock/本地索引计算：遍历 `tbom_test.json`/`tbom_run.json` 中与 `ebom_node_id` 匹配的记录；
  - 中期由 BFF 提供聚合接口（本规范不限定 API 形态）。

## 8. 空/错/无权限状态
- 空：徽标不出现（或灰 0），Popover 显示“无挂接试验”。
- 错：徽标红点；Popover 提示“加载失败”，含“重试”。
- 权限：隐藏计数，仅显示“试验（受限）”。

## 9. 文案与多语言（建议 key）
- `tests.badge` → 试验
- `tests.count` → 共有 {count} 次试验运行
- `tests.openInTbom` → 在 TBOM 中查看
- `tests.openInNewTab` → 在新标签页打开

## 10. 验收关联（映射至 PRD 故事）
- Story 1.2：TBOM 详情右侧“关联”面板展示 `ebom_node_id/ebom_path` 并支持反向进入结构视图。
- Story 1.5：跨域关联与可追溯，要求从结构节点直达 TBOM，并返回保持上下文。
- Story 1.9：EBOM 结构视图挂接入口与徽标（本规范为其验收依据）。

---

> 注：原型阶段不强制真实接口；优先保证导航一致性与可访问性，计数与分布信息可从 Mock 索引计算。
